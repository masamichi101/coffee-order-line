{% extends "line/base.html" %}
{% load static %}

{% block content %}
<div class="mb-5">
  <a href="{% url 'line:index' %}?line_id={{ line_id }}" class="text-blue-600 hover:text-blue-800">â† ã‚·ãƒ§ãƒƒãƒ—ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>

<div class="mb-5">
  <h1 class="text-3xl font-bold text-center">ğŸ›’ ã‚«ãƒ¼ãƒˆ</h1>
</div>

{% if cart and cart.items.exists %}
<div class="mb-6">
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-bold mb-4">ã‚«ãƒ¼ãƒˆå†…ã®å•†å“</h2>
    
    {% for item in cart.items.all %}
    <div class="border-b flex flex-row justify-between py-4 last:border-b-0">
      <div class="flex items-center space-x-4">
        <div class="w-20 h-20 flex-shrink-0">
          {% if item.product.image %}
          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-cover rounded">
          {% else %}
          <div class="w-full h-full bg-gray-200 rounded flex items-center justify-center">
            <span class="text-gray-500 text-sm">ğŸ“·</span>
          </div>
          {% endif %}
        </div>
        
        <div class="flex-1">
          <h3 class="font-bold">{{ item.product.name }}</h3>
          <p class="text-sm text-gray-600">{{ item.product.shop.name }}</p>
          <p class="text-lg font-bold text-red-600">Â¥{{ item.product.price }}</p>
        </div>
        
        <div class="text-right">
         
        </div>
      </div>
      <div class="flex flex-col space-y-2">
        <div class="flex flex-col md:flex-row md:items-start md:space-x-6"></div>
        <!-- æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form method="post" action="{% url 'line:cart' %}?line_id={{ line_id }}" 
              class="flex flex-col space-y-2 ">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_quantity">
          <input type="hidden" name="item_id" value="{{ item.id }}">
          
          <div class="flex items-center border rounded-lg overflow-hidden">
            <button type="button" onclick="decreaseQuantity('{{ item.id }}')" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors">
              â–
            </button>
            <input type="number" name="quantity" id="quantity-{{ item.id }}" value="{{ item.quantity }}" min="1" max="99" 
                   class="w-16 px-3 py-2 border-0 text-center focus:outline-none">
            <button type="button" onclick="increaseQuantity('{{ item.id }}')" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors">
              â•
            </button>
          </div>
          
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors border border-blue-700 w-full sm:w-auto">
            âœï¸ æ›´æ–°
          </button>
        </form>
      
        <!-- å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form method="post" action="{% url 'line:cart' %}?line_id={{ line_id }}" class="inline w-full sm:w-auto">
          {% csrf_token %}
          <input type="hidden" name="action" value="remove_item">
          <input type="hidden" name="item_id" value="{{ item.id }}">
          <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors border border-red-700 w-full sm:w-auto">
            ğŸ—‘ï¸ å‰Šé™¤
          </button>
        </form>
      </div>
      
    </div>
    <div class="mt-3 text-right">
        <span class="text-lg font-bold text-gray-800">å°è¨ˆ: Â¥{{ item.subtotal }}</span>
      </div>
      
      
      
    {% endfor %}
    
    <div class="mt-6 pt-4 border-t">
      <div class="flex justify-between items-center text-xl font-bold mb-2">
        <span>åˆè¨ˆé‡‘é¡:</span>
        <span class="text-red-600">Â¥{{ cart.total_price }}</span>
      </div>
      <div class="flex justify-between items-center text-sm text-gray-600">
        <span>å•†å“æ•°:</span>
        <span>{{ cart.item_count }}å€‹</span>
      </div>
    </div>
  </div>
</div>

<div class="text-center space-y-4">
  <a href="{% url 'line:order_confirm' %}?line_id={{ line_id }}" class="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-green-700 transition-colors border-2 border-green-700 shadow-lg block">
    ğŸ›’ æ³¨æ–‡ã«é€²ã‚€
  </a>
  
  {% if shop_id %}
  <a href="{% url 'line:product' shop_id=shop_id %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors border border-blue-700 block">
    ğŸ¹ å•†å“ä¸€è¦§ã«æˆ»ã‚‹
  </a>
  {% else %}
  <a href="{% url 'line:index' %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors border border-blue-700 block">
    ğŸ¹ å•†å“ä¸€è¦§ã«æˆ»ã‚‹
  </a>
  {% endif %}
</div>

{% else %}
<div class="text-center py-20">
  <div class="text-6xl mb-4">ğŸ›’</div>
  <h2 class="text-2xl font-bold text-gray-600 mb-4">ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™</h2>
  <p class="text-gray-500 mb-8">å•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„</p>
  {% if shop_id %}
  <a href="{% url 'line:product' shop_id=shop_id %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors border-2 border-blue-700 shadow-lg">
    å•†å“ä¸€è¦§ã‚’è¦‹ã‚‹
  </a>
  {% else %}
  <a href="{% url 'line:index' %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors border-2 border-blue-700 shadow-lg">
 ã‚·ãƒ§ãƒƒãƒ—ä¸€è¦§ã‚’è¦‹ã‚‹
  </a>
  {% endif %}
</div>
{% endif %}

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
{% if messages %}
<div class="fixed top-4 right-4 z-50">
  {% for message in messages %}
  <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-2 shadow-lg">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<script>
function decreaseQuantity(itemId) {
  const input = document.getElementById(`quantity-${itemId}`);
  if (input.value > 1) {
    input.value = parseInt(input.value) - 1;
  }
}

function increaseQuantity(itemId) {
  const input = document.getElementById(`quantity-${itemId}`);
  if (input.value < 99) {
    input.value = parseInt(input.value) + 1;
  }
}

// LIFFèªè¨¼ã¨line_idã®è‡ªå‹•å–å¾—
document.addEventListener('DOMContentLoaded', function() {
  // å…±é€šã®LINEèªè¨¼ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨
  const lineAuth = new LineAuth("{{ liff_id }}");
  
  // ãƒšãƒ¼ã‚¸ã‚’åˆæœŸåŒ–
  lineAuth.initializePage({
    updateShopLinks: false,
    updateCartLinks: true,
    updateOrderHistoryLinks: false,
    showLoginStatus: false
  }).then((isLoggedIn) => {
    if (isLoggedIn) {
      // line_idãŒå–å¾—ã§ããŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ã®actionå±æ€§ã¨ãƒªãƒ³ã‚¯ã‚’æ›´æ–°
      updateFormActions();
    }
  });
});

// ãƒ•ã‚©ãƒ¼ãƒ ã®actionå±æ€§ã¨ãƒªãƒ³ã‚¯ã‚’æ›´æ–°
function updateFormActions() {
  const lineAuth = window.lineAuth || new LineAuth("{{ liff_id }}");
  const lineId = lineAuth.getLineId();
  
  if (lineId) {
    // ã‚«ãƒ¼ãƒˆæ›´æ–°ãƒ»å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ ã®actionã‚’æ›´æ–°
    const forms = document.querySelectorAll('form[action*="line:cart"]');
    forms.forEach(form => {
      form.action = `/line/cart/?line_id=${lineId}`;
    });
    
    // æ³¨æ–‡ç¢ºèªãƒªãƒ³ã‚¯ã®hrefã‚’æ›´æ–°
    const orderConfirmLinks = document.querySelectorAll('a[href*="line:order_confirm"]');
    orderConfirmLinks.forEach(link => {
      link.href = `/line/order/confirm/?line_id=${lineId}`;
    });
    
    // å•†å“ä¸€è¦§ã«æˆ»ã‚‹ãƒªãƒ³ã‚¯ã®hrefã‚’æ›´æ–°
    const productLinks = document.querySelectorAll('a[href*="line:product"]');
    productLinks.forEach(link => {
      const shopId = link.href.match(/shop_id=(\d+)/)?.[1];
      if (shopId) {
        link.href = `/line/product/${shopId}/?line_id=${lineId}`;
      }
    });
    
    // ã‚·ãƒ§ãƒƒãƒ—ä¸€è¦§ã«æˆ»ã‚‹ãƒªãƒ³ã‚¯ã®hrefã‚’æ›´æ–°
    const indexLinks = document.querySelectorAll('a[href*="line:index"]');
    indexLinks.forEach(link => {
      link.href = `/line/?line_id=${lineId}`;
    });
  }
}
</script>

{% endblock %} 