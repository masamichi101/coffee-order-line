{% extends "line/base.html" %}
{% load static %}

{% block content %}
<div class="mb-5">
  <a href="{% url 'line:index' %}?line_id={{ line_id }}" class="text-blue-600 hover:text-blue-800">← ショップ一覧に戻る</a>
</div>

<div class="mb-5">
  <h1 class="text-3xl font-bold text-center">🛒 カート</h1>
</div>

{% if cart and cart.items.exists %}
<div class="mb-6">
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-bold mb-4">カート内の商品</h2>
    
    {% for item in cart.items.all %}
    <div class="border-b flex flex-row justify-between py-4 last:border-b-0">
      <div class="flex items-center space-x-4">
        <div class="w-20 h-20 flex-shrink-0">
          {% if item.product.image %}
          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-cover rounded">
          {% else %}
          <div class="w-full h-full bg-gray-200 rounded flex items-center justify-center">
            <span class="text-gray-500 text-sm">📷</span>
          </div>
          {% endif %}
        </div>
        
        <div class="flex-1">
          <h3 class="font-bold">{{ item.product.name }}</h3>
          <p class="text-sm text-gray-600">{{ item.product.shop.name }}</p>
          <p class="text-lg font-bold text-red-600">¥{{ item.product.price }}</p>
        </div>
        
        <div class="text-right">
         
        </div>
      </div>
      <div class="flex flex-col space-y-2">
        <div class="flex flex-col md:flex-row md:items-start md:space-x-6"></div>
        <!-- 更新フォーム -->
        <form method="post" action="{% url 'line:cart' %}?line_id={{ line_id }}" 
              class="flex flex-col space-y-2 ">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_quantity">
          <input type="hidden" name="item_id" value="{{ item.id }}">
          
          <div class="flex items-center border rounded-lg overflow-hidden">
            <button type="button" onclick="decreaseQuantity('{{ item.id }}')" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors">
              ➖
            </button>
            <input type="number" name="quantity" id="quantity-{{ item.id }}" value="{{ item.quantity }}" min="1" max="99" 
                   class="w-16 px-3 py-2 border-0 text-center focus:outline-none">
            <button type="button" onclick="increaseQuantity('{{ item.id }}')" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors">
              ➕
            </button>
          </div>
          
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors border border-blue-700 w-full sm:w-auto">
            ✏️ 更新
          </button>
        </form>
      
        <!-- 削除フォーム -->
        <form method="post" action="{% url 'line:cart' %}?line_id={{ line_id }}" class="inline w-full sm:w-auto">
          {% csrf_token %}
          <input type="hidden" name="action" value="remove_item">
          <input type="hidden" name="item_id" value="{{ item.id }}">
          <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors border border-red-700 w-full sm:w-auto">
            🗑️ 削除
          </button>
        </form>
      </div>
      
    </div>
    <div class="mt-3 text-right">
        <span class="text-lg font-bold text-gray-800">小計: ¥{{ item.subtotal }}</span>
      </div>
      
      
      
    {% endfor %}
    
    <div class="mt-6 pt-4 border-t">
      <div class="flex justify-between items-center text-xl font-bold mb-2">
        <span>合計金額:</span>
        <span class="text-red-600">¥{{ cart.total_price }}</span>
      </div>
      <div class="flex justify-between items-center text-sm text-gray-600">
        <span>商品数:</span>
        <span>{{ cart.item_count }}個</span>
      </div>
    </div>
  </div>
</div>

<div class="text-center space-y-4">
  <a href="{% url 'line:order_confirm' %}?line_id={{ line_id }}" class="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-green-700 transition-colors border-2 border-green-700 shadow-lg block">
    🛒 注文に進む
  </a>
  
  {% if shop_id %}
  <a href="{% url 'line:product' shop_id=shop_id %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors border border-blue-700 block">
    🍹 商品一覧に戻る
  </a>
  {% else %}
  <a href="{% url 'line:index' %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors border border-blue-700 block">
    🍹 商品一覧に戻る
  </a>
  {% endif %}
</div>

{% else %}
<div class="text-center py-20">
  <div class="text-6xl mb-4">🛒</div>
  <h2 class="text-2xl font-bold text-gray-600 mb-4">カートが空です</h2>
  <p class="text-gray-500 mb-8">商品をカートに追加してください</p>
  {% if shop_id %}
  <a href="{% url 'line:product' shop_id=shop_id %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors border-2 border-blue-700 shadow-lg">
    商品一覧を見る
  </a>
  {% else %}
  <a href="{% url 'line:index' %}?line_id={{ line_id }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors border-2 border-blue-700 shadow-lg">
 ショップ一覧を見る
  </a>
  {% endif %}
</div>
{% endif %}

<!-- メッセージ表示 -->
{% if messages %}
<div class="fixed top-4 right-4 z-50">
  {% for message in messages %}
  <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-2 shadow-lg">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<script>
function decreaseQuantity(itemId) {
  const input = document.getElementById(`quantity-${itemId}`);
  if (input.value > 1) {
    input.value = parseInt(input.value) - 1;
  }
}

function increaseQuantity(itemId) {
  const input = document.getElementById(`quantity-${itemId}`);
  if (input.value < 99) {
    input.value = parseInt(input.value) + 1;
  }
}

// LIFF認証とline_idの自動取得
document.addEventListener('DOMContentLoaded', function() {
  // 共通のLINE認証クラスを使用
  const lineAuth = new LineAuth("{{ liff_id }}");
  
  // ページを初期化
  lineAuth.initializePage({
    updateShopLinks: false,
    updateCartLinks: true,
    updateOrderHistoryLinks: false,
    showLoginStatus: false
  }).then((isLoggedIn) => {
    if (isLoggedIn) {
      // line_idが取得できた場合、フォームのaction属性とリンクを更新
      updateFormActions();
    }
  });
});

// フォームのaction属性とリンクを更新
function updateFormActions() {
  const lineAuth = window.lineAuth || new LineAuth("{{ liff_id }}");
  const lineId = lineAuth.getLineId();
  
  if (lineId) {
    // カート更新・削除フォームのactionを更新
    const forms = document.querySelectorAll('form[action*="line:cart"]');
    forms.forEach(form => {
      form.action = `/line/cart/?line_id=${lineId}`;
    });
    
    // 注文確認リンクのhrefを更新
    const orderConfirmLinks = document.querySelectorAll('a[href*="line:order_confirm"]');
    orderConfirmLinks.forEach(link => {
      link.href = `/line/order/confirm/?line_id=${lineId}`;
    });
    
    // 商品一覧に戻るリンクのhrefを更新
    const productLinks = document.querySelectorAll('a[href*="line:product"]');
    productLinks.forEach(link => {
      const shopId = link.href.match(/shop_id=(\d+)/)?.[1];
      if (shopId) {
        link.href = `/line/product/${shopId}/?line_id=${lineId}`;
      }
    });
    
    // ショップ一覧に戻るリンクのhrefを更新
    const indexLinks = document.querySelectorAll('a[href*="line:index"]');
    indexLinks.forEach(link => {
      link.href = `/line/?line_id=${lineId}`;
    });
  }
}
</script>

{% endblock %} 